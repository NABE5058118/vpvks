# ğŸ” VPN Bot Project â€” ĞŸĞ¾Ğ»Ğ½Ğ¾Ğµ Ñ€ÑƒĞºĞ¾Ğ²Ğ¾Ğ´ÑÑ‚Ğ²Ğ¾ (vpvks.ru)

> **ĞŸĞ¾ÑĞ»ĞµĞ´Ğ½ĞµĞµ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ:** 21 Ñ„ĞµĞ²Ñ€Ğ°Ğ»Ñ 2026 Ğ³.  
> **Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ:** âœ… Ğ’ÑĞµ ÑĞµÑ€Ğ²Ğ¸ÑÑ‹ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ÑÑ‚  
> **Ğ¡ĞµÑ€Ğ²ĞµÑ€:** 23.134.216.190 (Ubuntu 24.04.4 LTS)  
> **Ğ”Ğ¾Ğ¼ĞµĞ½:** vpvks.ru (SSL: Let's Encrypt)

---

## ğŸ“‹ Ğ¡Ğ¾Ğ´ĞµÑ€Ğ¶Ğ°Ğ½Ğ¸Ğµ

1. [Ğ Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ğµ](#-Ğ¾-Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ğµ)
2. [ĞÑ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ğ°](#-Ğ°Ñ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ğ°)
3. [Ğ‘Ñ‹ÑÑ‚Ñ€Ñ‹Ğ¹ ÑÑ‚Ğ°Ñ€Ñ‚](#-Ğ±Ñ‹ÑÑ‚Ñ€Ñ‹Ğ¹-ÑÑ‚Ğ°Ñ€Ñ‚)
4. [ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ° Marzban â€” Ğ¿Ğ¾Ğ´Ğ²Ğ¾Ğ´Ğ½Ñ‹Ğµ ĞºĞ°Ğ¼Ğ½Ğ¸](#-Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ°-marzban--Ğ¿Ğ¾Ğ´Ğ²Ğ¾Ğ´Ğ½Ñ‹Ğµ-ĞºĞ°Ğ¼Ğ½Ğ¸)
5. [ĞšĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ñ](#-ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ñ)
6. [ĞšĞ¾Ğ¼Ğ°Ğ½Ğ´Ñ‹ ÑƒĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ](#-ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ñ‹-ÑƒĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ)
7. [Ğ”Ğ¾ÑÑ‚ÑƒĞ¿ Ğº Ğ¿Ğ°Ğ½ĞµĞ»ÑĞ¼](#-Ğ´Ğ¾ÑÑ‚ÑƒĞ¿-Ğº-Ğ¿Ğ°Ğ½ĞµĞ»ÑĞ¼)
8. [Troubleshooting](#-troubleshooting)
9. [Ğ‘ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾ÑÑ‚ÑŒ](#-Ğ±ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾ÑÑ‚ÑŒ)

---

## ğŸ“– Ğ Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ğµ

Telegram-Ğ±Ğ¾Ñ‚ Ğ´Ğ»Ñ ÑƒĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ VPN-Ğ¿Ğ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸ÑĞ¼Ğ¸ Ñ Ğ¼Ğ¸Ğ½Ğ¸-Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸ĞµĞ¼, ÑĞ¸ÑÑ‚ĞµĞ¼Ğ¾Ğ¹ Ğ¾Ğ¿Ğ»Ğ°Ñ‚Ñ‹ Ğ¸ Ğ¿Ğ¾Ğ´Ğ´ĞµÑ€Ğ¶ĞºĞ¾Ğ¹ Ğ´Ğ²ÑƒÑ… Ğ¿Ñ€Ğ¾Ñ‚Ğ¾ĞºĞ¾Ğ»Ğ¾Ğ²:

| ĞŸÑ€Ğ¾Ñ‚Ğ¾ĞºĞ¾Ğ» | ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ |
|----------|----------|
| **WireGuard** | ĞšĞ»Ğ°ÑÑĞ¸Ñ‡ĞµÑĞºĞ¸Ğ¹ VPN, Ğ²Ñ‹ÑĞ¾ĞºĞ°Ñ ÑĞºĞ¾Ñ€Ğ¾ÑÑ‚ÑŒ |
| **V2Ray/Trojan/Reality** | Ğ§ĞµÑ€ĞµĞ· Marzban, Ğ´Ğ»Ñ Ğ¾Ğ±Ñ…Ğ¾Ğ´Ğ° Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€Ğ¾Ğ²Ğ¾Ğº |

### Ğ’Ğ¾Ğ·Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ÑÑ‚Ğ¸

- âœ… Telegram Mini App (Web App)
- âœ… YooKassa Ğ¸Ğ½Ñ‚ĞµĞ³Ñ€Ğ°Ñ†Ğ¸Ñ (Ğ¿Ñ€Ğ¾Ğ´Ğ°ĞºÑˆĞµĞ½)
- âœ… ĞĞ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ°Ñ Ğ²Ñ‹Ğ´Ğ°Ñ‡Ğ° Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞ¾Ğº
- âœ… ĞœĞ¾Ğ½Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ğ½Ğ³ Ñ‚Ñ€Ğ°Ñ„Ğ¸ĞºĞ°
- âœ… ĞœÑƒĞ»ÑŒÑ‚Ğ¸Ğ¿Ñ€Ğ¾Ñ‚Ğ¾ĞºĞ¾Ğ»ÑŒĞ½Ğ¾ÑÑ‚ÑŒ

---

## ğŸ—ï¸ ĞÑ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ğ°

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        nginx:443 (SSL)                          â”‚
â”‚                    reverse proxy Ğ´Ğ»Ñ Ğ²ÑĞµÑ… ÑĞµÑ€Ğ²Ğ¸ÑĞ¾Ğ²               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                    â”‚                    â”‚
        â–¼                    â–¼                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Backend:8080  â”‚   â”‚ Marzban:8000  â”‚   â”‚WireGuard:51820â”‚
â”‚ (Flask API)   â”‚   â”‚ (V2Ray/Xray)  â”‚   â”‚ (UDP)         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚                   â”‚
        â–¼                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PgBouncer:6432â”‚   â”‚   SQLite      â”‚
â”‚ (pooler)      â”‚   â”‚   db.sqlite3  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PostgreSQL:5432â”‚
â”‚ (Docker)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Ğ Ğ°ÑĞ¿Ñ€ĞµĞ´ĞµĞ»ĞµĞ½Ğ¸Ğµ Ğ±Ğ°Ğ· Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…

| ĞšĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚ | Ğ‘Ğ” | Ğ Ğ°ÑĞ¿Ğ¾Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµ |
|-----------|-----|--------------|
| Telegram Ğ±Ğ¾Ñ‚ | PostgreSQL 17 | Docker `vpn_postgres` |
| Backend (Flask) | PostgreSQL | Ğ§ĞµÑ€ĞµĞ· PgBouncer |
| **Marzban** | **SQLite** | `/var/lib/marzban/db.sqlite3` |
| WireGuard | ĞĞµÑ‚ | ĞšĞ¾Ğ½Ñ„Ğ¸Ğ³Ğ¸ Ğ² `/etc/wireguard/` |

### Ğ¡Ñ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğ° Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ğ°

```
/opt/vpvks/
â”œâ”€â”€ docker-compose.yml          # ĞÑ€ĞºĞµÑÑ‚Ñ€Ğ°Ñ†Ğ¸Ñ Ğ²ÑĞµÑ… ÑĞµÑ€Ğ²Ğ¸ÑĞ¾Ğ²
â”œâ”€â”€ .env                        # ĞŸĞµÑ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ğµ Ğ¾ĞºÑ€ÑƒĞ¶ĞµĞ½Ğ¸Ñ (ÑĞµĞºÑ€ĞµÑ‚Ñ‹)
â”œâ”€â”€ marzban.env                 # ĞŸĞµÑ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ğµ Ğ´Ğ»Ñ Marzban
â”‚
â”œâ”€â”€ backend/                    # Flask API ÑĞµÑ€Ğ²ĞµÑ€
â”‚   â”œâ”€â”€ server.py
â”‚   â”œâ”€â”€ routes/
â”‚   â”œâ”€â”€ models/
â”‚   â””â”€â”€ templates/miniapp.html
â”‚
â”œâ”€â”€ bot/                        # Telegram Ğ±Ğ¾Ñ‚
â”‚   â”œâ”€â”€ main.py
â”‚   â””â”€â”€ handlers/
â”‚
â”œâ”€â”€ pgbouncer/                  # PgBouncer ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³
â”‚   â””â”€â”€ pgbouncer.ini
â”‚
â””â”€â”€ marzban/                    # Marzban (Ğ»Ğ¾ĞºĞ°Ğ»ÑŒĞ½Ğ°Ñ ĞºĞ¾Ğ¿Ğ¸Ñ)
    â””â”€â”€ docker-compose.yml
```

---

## ğŸš€ Ğ‘Ñ‹ÑÑ‚Ñ€Ñ‹Ğ¹ ÑÑ‚Ğ°Ñ€Ñ‚

### 1. ĞŸĞ¾Ğ´Ğ³Ğ¾Ñ‚Ğ¾Ğ²ĞºĞ° ÑĞµÑ€Ğ²ĞµÑ€Ğ°

```bash
# ĞĞ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ ÑĞ¸ÑÑ‚ĞµĞ¼Ñ‹
apt update && apt upgrade -y

# Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ° Docker
curl -fsSL https://get.docker.com | sh

# Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ° Docker Compose
apt install docker-compose-plugin -y

# ĞšĞ»Ğ¾Ğ½Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ñ€ĞµĞ¿Ğ¾Ğ·Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ñ
cd /opt
git clone https://github.com/NABE5058118/vpvks.git
cd vpvks
```

### 2. ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ° Ğ¿ĞµÑ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ñ… Ğ¾ĞºÑ€ÑƒĞ¶ĞµĞ½Ğ¸Ñ

```bash
# Ğ¡ĞºĞ¾Ğ¿Ğ¸Ñ€ÑƒĞ¹Ñ‚Ğµ Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€Ñ‹
cp .env.example .env
cp marzban.env.example marzban.env

# ĞÑ‚Ñ€ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€ÑƒĞ¹Ñ‚Ğµ Ğ¿Ğ¾Ğ´ ÑĞ²Ğ¾Ğ¸ Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ñ
nano .env
nano marzban.env
```

### 3. Ğ—Ğ°Ğ¿ÑƒÑĞº Ğ²ÑĞµÑ… ÑĞµÑ€Ğ²Ğ¸ÑĞ¾Ğ²

```bash
cd /opt/vpvks
docker compose up -d
```

### 4. ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° ÑÑ‚Ğ°Ñ‚ÑƒÑĞ°

```bash
docker compose ps
```

**ĞĞ¶Ğ¸Ğ´Ğ°ĞµĞ¼Ñ‹Ğ¹ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚:**
```
NAME            STATUS
vpn_bot         Up
vpn_backend     Up
vpn_pgbouncer   Up
vpn_postgres    Up (healthy)
marzban         Up
```

---

## âš ï¸ ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ° Marzban â€” ĞŸĞ¾Ğ´Ğ²Ğ¾Ğ´Ğ½Ñ‹Ğµ ĞºĞ°Ğ¼Ğ½Ğ¸

### ĞŸÑ€Ğ¾Ğ±Ğ»ĞµĞ¼Ğ° 1: Ğ‘Ğ°Ğ·Ğ° Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… (PostgreSQL â†’ SQLite)

**Ğ¡Ğ¸Ğ¼Ğ¿Ñ‚Ğ¾Ğ¼Ñ‹:**
```
sqlalchemy.exc.OperationalError: could not translate host name "marzban-db" to address
```

**ĞŸÑ€Ğ¸Ñ‡Ğ¸Ğ½Ğ°:** Marzban Ğ½Ğµ Ğ¼Ğ¾Ğ¶ĞµÑ‚ Ğ¿Ğ¾Ğ´ĞºĞ»ÑÑ‡Ğ¸Ñ‚ÑŒÑÑ Ğº PostgreSQL Ğ¿Ñ€Ğ¸ Ğ¼Ğ¸Ğ³Ñ€Ğ°Ñ†Ğ¸Ğ¸ Alembic.

**Ğ ĞµÑˆĞµĞ½Ğ¸Ğµ â€” Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ SQLite:**

```yaml
# docker-compose.yml
marzban:
  environment:
    - SQLALCHEMY_DATABASE_URL=sqlite:////var/lib/marzban/db.sqlite3
  network_mode: host  # Ğ’Ğ°Ğ¶Ğ½Ğ¾!
```

```env
# marzban.env
# DATABASE_URL Ğ½Ğµ Ñ‚Ñ€ĞµĞ±ÑƒĞµÑ‚ÑÑ Ğ´Ğ»Ñ SQLite
SECRET_KEY=your_secret_key
UVICORN_WORKERS=2
```

---

### ĞŸÑ€Ğ¾Ğ±Ğ»ĞµĞ¼Ğ° 2: UVICORN_HOST Ğ½Ğµ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµÑ‚

**Ğ¡Ğ¸Ğ¼Ğ¿Ñ‚Ğ¾Ğ¼Ñ‹:**
```
INFO: Uvicorn running on http://127.0.0.1:8000
```

Marzban ÑĞ»ÑƒÑˆĞ°ĞµÑ‚ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ localhost Ğ²Ğ½ÑƒÑ‚Ñ€Ğ¸ ĞºĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€Ğ°, nginx Ğ½Ğµ Ğ¼Ğ¾Ğ¶ĞµÑ‚ Ğ¿Ğ¾Ğ´ĞºĞ»ÑÑ‡Ğ¸Ñ‚ÑŒÑÑ.

**Ğ ĞµÑˆĞµĞ½Ğ¸Ğµ:**

```yaml
marzban:
  network_mode: host  # ĞĞ±ÑĞ·Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ğ¾!
  # Ğ£Ğ±Ñ€Ğ°Ñ‚ÑŒ networks: Ğ¸ ports:
```

**ĞŸÑ€ĞµĞ¸Ğ¼ÑƒÑ‰ĞµÑÑ‚Ğ²Ğ°:**
- Marzban ÑĞ»ÑƒÑˆĞ°ĞµÑ‚ Ğ½Ğ°Ğ¿Ñ€ÑĞ¼ÑƒÑ Ğ½Ğ° Ñ…Ğ¾ÑÑ‚Ğµ
- ĞĞµ Ğ½ÑƒĞ¶ĞµĞ½ Docker proxy
- ĞŸÑ€ÑĞ¼Ğ¾Ğ¹ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿ Ğº Ğ¿Ğ¾Ñ€Ñ‚Ñƒ 8000

---

### ĞŸÑ€Ğ¾Ğ±Ğ»ĞµĞ¼Ğ° 3: Nginx Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ 502 Bad Gateway

**Ğ¡Ğ¸Ğ¼Ğ¿Ñ‚Ğ¾Ğ¼Ñ‹:**
- `502 Bad Gateway` Ğ¿Ñ€Ğ¸ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğµ Ğº `marzban.vpvks.ru`
- Ğ˜Ğ»Ğ¸ ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ğ° Ğ·Ğ°Ğ³Ñ€ÑƒĞ¶Ğ°ĞµÑ‚ÑÑ, Ğ½Ğ¾ **Ğ½ĞµĞ¾Ğ½Ğ¾Ğ²Ğ°Ñ Ğ°Ğ½Ğ¸Ğ¼Ğ°Ñ†Ğ¸Ñ ĞºÑ€ÑƒÑ‚Ğ¸Ñ‚ÑÑ Ğ±ĞµÑĞºĞ¾Ğ½ĞµÑ‡Ğ½Ğ¾**

**ĞŸÑ€Ğ¸Ñ‡Ğ¸Ğ½Ñ‹:**
1. ĞŸĞ¾Ñ€Ñ‚ 80 Ğ·Ğ°Ğ½ÑÑ‚ Ğ¾ÑĞ½Ğ¾Ğ²Ğ½Ñ‹Ğ¼ nginx
2. ĞĞµĞ¿Ñ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ñ‹Ğ¹ `proxy_pass`
3. ĞĞµÑ‚ WebSocket Ğ¿Ğ¾Ğ´Ğ´ĞµÑ€Ğ¶ĞºĞ¸
4. ĞĞµĞ¿Ñ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ñ‹Ğµ Ğ¿ÑƒÑ‚Ğ¸ Ğº ÑÑ‚Ğ°Ñ‚Ğ¸ĞºĞµ (`/statics/`, `/dashboard/`)

**Ğ ĞµÑˆĞµĞ½Ğ¸Ğµ â€” Ğ¿Ğ¾Ğ»Ğ½Ñ‹Ğ¹ nginx ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³:**

```nginx
server {
    listen 443 ssl http2;
    server_name marzban.vpvks.ru;
    
    ssl_certificate /etc/letsencrypt/live/marzban.vpvks.ru/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/marzban.vpvks.ru/privkey.pem;

    # Dashboard
    location /dashboard/ {
        proxy_pass http://127.0.0.1:8000/dashboard/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
    
    # Ğ¡Ñ‚Ğ°Ñ‚Ğ¸ĞºĞ° (JS/CSS)
    location /statics/ {
        proxy_pass http://127.0.0.1:8000/statics/;
        proxy_set_header Host $host;
    }

    # API
    location /api/ {
        proxy_pass http://127.0.0.1:8000/api/;
        proxy_set_header Host $host;
    }

    # ĞÑĞ½Ğ¾Ğ²Ğ½Ğ¾Ğµ (WebSocket)
    location / {
        proxy_pass http://127.0.0.1:8000/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_buffering off;
        proxy_read_timeout 300s;
    }
}
```

```bash
nginx -t && nginx -s reload
```

---

### ĞŸÑ€Ğ¾Ğ±Ğ»ĞµĞ¼Ğ° 4: ĞĞµÑ‚ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ° Ğ² Ğ±Ğ°Ğ·Ğµ

**Ğ¡Ğ¸Ğ¼Ğ¿Ñ‚Ğ¾Ğ¼Ñ‹:**
- Ğ¡Ñ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ğ° Ğ»Ğ¾Ğ³Ğ¸Ğ½Ğ° Ğ·Ğ°Ğ³Ñ€ÑƒĞ¶Ğ°ĞµÑ‚ÑÑ
- Ğ’Ğ¾Ğ¹Ñ‚Ğ¸ Ğ½ĞµĞ²Ğ¾Ğ·Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ â€” Ğ°Ğ´Ğ¼Ğ¸Ğ½ Ğ½Ğµ ÑĞ¾Ğ·Ğ´Ğ°Ğ½

**ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ°:**
```bash
docker exec marzban python -c 'import sqlite3; c=sqlite3.connect("/var/lib/marzban/db.sqlite3"); print("ĞĞ´Ğ¼Ğ¸Ğ½Ñ‹:", c.execute("SELECT username FROM admins").fetchall())'
```

**Ğ ĞµÑˆĞµĞ½Ğ¸Ğµ â€” ÑĞ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ°:**

```bash
cat > /tmp/create_admin.py << 'EOF'
import sqlite3
from passlib.context import CryptContext

pwd_context = CryptContext(schemes=["bcrypt"], deprecated="auto")
password_hash = pwd_context.hash("j8X0EcIllDwPK")

conn = sqlite3.connect('/var/lib/marzban/db.sqlite3')
c = conn.cursor()

c.execute('''
    INSERT INTO admins (username, hashed_password, is_sudo, created_at)
    VALUES (?, ?, 1, datetime('now'))
''', ('admin', password_hash))

conn.commit()
print('ĞĞ´Ğ¼Ğ¸Ğ½ ÑĞ¾Ğ·Ğ´Ğ°Ğ½!')
conn.close()
EOF

docker cp /tmp/create_admin.py marzban:/tmp/create_admin.py
docker exec marzban python /tmp/create_admin.py
```

---

## âš™ï¸ ĞšĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ñ

### .env (Ğ¾ÑĞ½Ğ¾Ğ²Ğ½Ğ¾Ğ¹)

```env
# PostgreSQL
POSTGRES_DB=vpn_bot_db
POSTGRES_USER=vpn_bot_user
POSTGRES_PASSWORD=vp62RofV5h
PGDATA=/var/lib/postgresql/data

# PgBouncer
DATABASE_URL=postgresql://vpn_bot_user:vp62RofV5h@postgres:5432/vpn_bot_db
POOL_MODE=transaction
MAX_CLIENT_CONN=1000
DEFAULT_POOL_SIZE=50
AUTH_TYPE=scram-sha-256

# Backend
SECRET_KEY=5n_IX5ODiFJcuR0ZDH5s1cCRRAQYZcOiHYn4ZQ5xjEc
PORT=8080

# YooKassa
YOOKASSA_SHOP_ID=1266298
YOOKASSA_SECRET_KEY=live_xxx
YOOKASSA_TEST_MODE=false
YOOKASSA_RETURN_URL=https://vpvks.ru/payment-success

# WireGuard
WG_SERVER_IP=10.0.0.1
WG_PORT=51820
WG_SERVER_PUBLIC_KEY=xxx

# Bot
TELEGRAM_BOT_TOKEN=xxx
BACKEND_URL=https://vpvks.ru
ADMIN_USER_IDS=699469085
```

### marzban.env

```env
SECRET_KEY=7c1ac2b949198c0d8ac414776fd11b6beac83fb0a86acc9f1859c05384b717b5
UVICORN_WORKERS=2
XRAY_JSON=/var/lib/marzban/xray_config.json
SUDO_USERNAME=admin
SUDO_PASSWORD=j8X0EcIllDwPK
SUBSCRIPTION_URL_PREFIX=https://vpvks.ru
```

### docker-compose.yml (Ñ„Ñ€Ğ°Ğ³Ğ¼ĞµĞ½Ñ‚ Marzban)

```yaml
marzban:
  build:
    context: .
    dockerfile: Dockerfile.marzban
  container_name: marzban
  restart: always
  env_file:
    - marzban.env
  environment:
    - SQLALCHEMY_DATABASE_URL=sqlite:////var/lib/marzban/db.sqlite3
    - XRAY_JSON=/var/lib/marzban/xray_config.json
  network_mode: host
  volumes:
    - /var/lib/marzban:/var/lib/marzban
    - /etc/letsencrypt:/etc/letsencrypt:ro
```

---

## ğŸ›ï¸ ĞšĞ¾Ğ¼Ğ°Ğ½Ğ´Ñ‹ ÑƒĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ

### Ğ—Ğ°Ğ¿ÑƒÑĞº / Ğ¾ÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ°

```bash
# Ğ’ÑĞµ ÑĞµÑ€Ğ²Ğ¸ÑÑ‹
docker compose up -d
docker compose down

# ĞÑ‚Ğ´ĞµĞ»ÑŒĞ½Ñ‹Ğ¹ ÑĞµÑ€Ğ²Ğ¸Ñ
docker compose up -d marzban
docker compose stop marzban
```

### Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ Ğ¸ Ğ»Ğ¾Ğ³Ğ¸

```bash
# Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ Ğ²ÑĞµÑ…
docker compose ps

# Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ Marzban
docker compose ps marzban
docker compose logs marzban | tail -30

# Ğ›Ğ¾Ğ³Ğ¸ Ğ² Ñ€ĞµĞ°Ğ»ÑŒĞ½Ğ¾Ğ¼ Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ¸
docker compose logs -f
docker compose logs -f marzban
```

### ĞŸĞµÑ€ĞµĞ·Ğ°Ğ¿ÑƒÑĞº / Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ

```bash
# ĞŸĞµÑ€ĞµĞ·Ğ°Ğ¿ÑƒÑĞº
docker compose restart
docker compose restart marzban

# ĞĞ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ¾Ğ±Ñ€Ğ°Ğ·Ğ¾Ğ²
docker compose pull
docker compose up -d --force-recreate
```

### ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ‘Ğ” Marzban

```bash
# Ğ¢Ğ°Ğ±Ğ»Ğ¸Ñ†Ñ‹
docker exec marzban python -c 'import sqlite3; c=sqlite3.connect("/var/lib/marzban/db.sqlite3"); print("Ğ¢Ğ°Ğ±Ğ»Ğ¸Ñ†Ñ‹:", [t[0] for t in c.execute("SELECT name FROM sqlite_master WHERE type=\"table\"")])'

# ĞĞ´Ğ¼Ğ¸Ğ½Ñ‹
docker exec marzban python -c 'import sqlite3; c=sqlite3.connect("/var/lib/marzban/db.sqlite3"); print("ĞĞ´Ğ¼Ğ¸Ğ½Ñ‹:", c.execute("SELECT username FROM admins").fetchall())'
```

### Nginx

```bash
# ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³Ğ°
nginx -t

# ĞŸĞµÑ€ĞµĞ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ°
nginx -s reload

# Ğ›Ğ¾Ğ³Ğ¸
tail -f /var/log/nginx/error.log
```

---

## ğŸŒ Ğ”Ğ¾ÑÑ‚ÑƒĞ¿ Ğº Ğ¿Ğ°Ğ½ĞµĞ»ÑĞ¼

### Marzban Panel

| ĞŸĞ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€ | Ğ—Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ğµ |
|----------|----------|
| **URL** | `https://marzban.vpvks.ru/dashboard/` |
| **Ğ›Ğ¾Ğ³Ğ¸Ğ½** | `admin` |
| **ĞŸĞ°Ñ€Ğ¾Ğ»ÑŒ** | `j8X0EcIllDwPK` |

**Ğ§ĞµÑ€ĞµĞ· SSH Ñ‚ÑƒĞ½Ğ½ĞµĞ»ÑŒ:**
```bash
ssh -L 8000:localhost:8000 root@23.134.216.190
# Ğ—Ğ°Ñ‚ĞµĞ¼: http://127.0.0.1:8000/dashboard/
```

### Telegram Bot

| ĞŸĞ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€ | Ğ—Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ğµ |
|----------|----------|
| **Ğ‘Ğ¾Ñ‚** | [@relatevpnbot](https://t.me/relatevpnbot) |
| **ĞšĞ¾Ğ¼Ğ°Ğ½Ğ´Ñ‹** | `/start`, `/app`, `/status`, `/connect` |

### Mini App

| ĞŸĞ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€ | Ğ—Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ğµ |
|----------|----------|
| **URL** | `https://vpvks.ru/miniapp` |
| **Ğ”Ğ¾ÑÑ‚ÑƒĞ¿** | Ğ§ĞµÑ€ĞµĞ· Ğ±Ğ¾Ñ‚Ğ° ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ğ¾Ğ¹ `/app` |

---

## ğŸ”§ Troubleshooting

### Marzban Ğ½Ğµ Ğ·Ğ°Ğ¿ÑƒÑĞºĞ°ĞµÑ‚ÑÑ

```bash
# ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑŒ Ğ»Ğ¾Ğ³Ğ¸
docker compose logs marzban | tail -50

# ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑŒ Ğ¿ĞµÑ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ğµ
docker exec marzban env | grep -i "database\|uvicorn"

# ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑŒ Ğ‘Ğ”
ls -la /var/lib/marzban/db.sqlite3
```

### 502 Bad Gateway

```bash
# Ğ¡Ğ»ÑƒÑˆĞ°ĞµÑ‚ Ğ»Ğ¸ Marzban
ss -tulpn | grep 8000

# ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑŒ nginx
nginx -t
tail -f /var/log/nginx/error.log | grep marzban
```

### ĞĞµĞ¾Ğ½Ğ¾Ğ²Ğ°Ñ Ğ°Ğ½Ğ¸Ğ¼Ğ°Ñ†Ğ¸Ñ ĞºÑ€ÑƒÑ‚Ğ¸Ñ‚ÑÑ

1. ĞÑ‚ĞºÑ€Ğ¾Ğ¹ **F12 â†’ Console** â€” Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ÑŒ Ğ¾ÑˆĞ¸Ğ±ĞºĞ¸ JavaScript
2. ĞÑ‚ĞºÑ€Ğ¾Ğ¹ **F12 â†’ Network** â€” Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ÑŒ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑÑ‹ Ğº `/api/` Ğ¸ `/statics/`
3. ĞÑ‡Ğ¸ÑÑ‚Ğ¸ ĞºÑÑˆ: **Cmd+Shift+R** (Mac) Ğ¸Ğ»Ğ¸ **Ctrl+Shift+R** (Windows)

```bash
# ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑŒ nginx ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³
nginx -t && nginx -s reload
```

### Backend Ğ½Ğµ Ğ¿Ğ¾Ğ´ĞºĞ»ÑÑ‡Ğ°ĞµÑ‚ÑÑ Ğº Ğ‘Ğ”

```bash
# ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑŒ DATABASE_URL
cat /opt/vpvks/.env | grep DATABASE_URL
# Ğ”Ğ¾Ğ»Ğ¶Ğ½Ğ¾ Ğ±Ñ‹Ñ‚ÑŒ: @postgres:5432 (Ğ½Ğµ @pgbouncer!)

# ĞŸĞµÑ€ĞµĞ·Ğ°Ğ¿ÑƒÑÑ‚Ğ¸
docker compose restart backend pgbouncer postgres
```

### WireGuard Ğ½Ğµ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµÑ‚

```bash
# Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ
sudo wg show

# ĞŸĞ¾Ñ€Ñ‚
sudo ss -tulpn | grep 51820

# ĞŸĞµÑ€ĞµĞ·Ğ°Ğ¿ÑƒÑĞº
sudo systemctl restart wg-quick@wg0
```

---

## ğŸ”’ Ğ‘ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾ÑÑ‚ÑŒ

### ĞšÑ€Ğ¸Ñ‚Ğ¸Ñ‡Ğ½Ñ‹Ğµ Ñ„Ğ°Ğ¹Ğ»Ñ‹

| Ğ¤Ğ°Ğ¹Ğ» | Ğ¡ĞµĞºÑ€ĞµÑ‚Ñ‹ |
|------|---------|
| `.env` | âœ… ĞŸĞ°Ñ€Ğ¾Ğ»Ğ¸ Ğ‘Ğ”, Ñ‚Ğ¾ĞºĞµĞ½Ñ‹ |
| `marzban.env` | âœ… SECRET_KEY, Ğ¿Ğ°Ñ€Ğ¾Ğ»ÑŒ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ° |
| `/etc/wireguard/*` | âœ… ĞŸÑ€Ğ¸Ğ²Ğ°Ñ‚Ğ½Ñ‹Ğµ ĞºĞ»ÑÑ‡Ğ¸ |
| `/etc/letsencrypt/*` | âœ… SSL ÑĞµÑ€Ñ‚Ğ¸Ñ„Ğ¸ĞºĞ°Ñ‚Ñ‹ |
| `/var/lib/marzban/db.sqlite3` | âœ… Ğ‘Ğ” Marzban |

### Ğ ĞµĞºĞ¾Ğ¼ĞµĞ½Ğ´Ğ°Ñ†Ğ¸Ğ¸

1. **ĞĞµ ĞºĞ¾Ğ¼Ğ¼Ğ¸Ñ‚ÑŒÑ‚Ğµ `.env` Ğ² git** â€” Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹Ñ‚Ğµ `.env.example`
2. **Ğ¡Ğ¼ĞµĞ½Ğ¸Ñ‚Ğµ Ğ¿Ğ°Ñ€Ğ¾Ğ»Ğ¸ Ğ¿Ğ¾ ÑƒĞ¼Ğ¾Ğ»Ñ‡Ğ°Ğ½Ğ¸Ñ** â€” Ğ¾ÑĞ¾Ğ±ĞµĞ½Ğ½Ğ¾ Ğ´Ğ»Ñ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ° Marzban
3. **ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹Ñ‚Ğµ firewall**:
   ```bash
   ufw allow 22/tcp    # SSH
   ufw allow 80/tcp    # HTTP
   ufw allow 443/tcp   # HTTPS
   ufw allow 51820/udp # WireGuard
   ufw enable
   ```
4. **Ğ ĞµĞ³ÑƒĞ»ÑÑ€Ğ½Ğ¾ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ÑĞ¹Ñ‚ĞµÑÑŒ**:
   ```bash
   apt update && apt upgrade -y
   docker compose pull
   docker compose up -d
   ```

---

## ğŸ“Š ĞŸĞ¾Ñ€Ñ‚Ñ‹ ÑĞµÑ€Ğ²Ğ¸ÑĞ¾Ğ²

| Ğ¡ĞµÑ€Ğ²Ğ¸Ñ | ĞŸĞ¾Ñ€Ñ‚ | ĞŸÑ€Ğ¾Ñ‚Ğ¾ĞºĞ¾Ğ» | Ğ”Ğ¾ÑÑ‚ÑƒĞ¿ |
|--------|------|----------|--------|
| nginx | 80, 443 | TCP | Ğ’Ğ½ĞµÑˆĞ½Ğ¸Ğ¹ |
| Backend | 8080 | TCP | localhost |
| Marzban | 8000 | TCP | localhost |
| PgBouncer | 6432 | TCP | Ğ’Ğ½ĞµÑˆĞ½Ğ¸Ğ¹ |
| WireGuard | 51820 | UDP | Ğ’Ğ½ĞµÑˆĞ½Ğ¸Ğ¹ |
| PostgreSQL | 5432 | TCP | Docker network |

---

## ğŸ“ ĞšĞ¾Ğ½Ñ‚Ğ°ĞºÑ‚Ñ‹

| ĞŸĞ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€ | Ğ—Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ğµ |
|----------|----------|
| **Ğ¡ĞµÑ€Ğ²ĞµÑ€** | 23.134.216.190 |
| **Ğ”Ğ¾Ğ¼ĞµĞ½** | vpvks.ru |
| **Ğ‘Ğ¾Ñ‚** | @relatevpnbot |
| **Admin ID** | 699469085 |
| **ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ** | `vpvks` (Ğ±ĞµĞ· Ğ¿Ñ€Ğ°Ğ²Ğ° Ğ»Ğ¾Ğ³Ğ¸Ğ½Ğ°) |

---

## ğŸ“š Ğ˜ÑÑ‚Ğ¾Ñ€Ğ¸Ñ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğ¹

### 21 Ñ„ĞµĞ²Ñ€Ğ°Ğ»Ñ 2026
- âœ… Marzban Ğ½Ğ°ÑÑ‚Ñ€Ğ¾ĞµĞ½ Ñ SQLite (Ñ€ĞµÑˆĞµĞ½Ñ‹ Ğ¿Ñ€Ğ¾Ğ±Ğ»ĞµĞ¼Ñ‹ Ñ Ğ¼Ğ¸Ğ³Ñ€Ğ°Ñ†Ğ¸ĞµĞ¹)
- âœ… Nginx Ğ½Ğ°ÑÑ‚Ñ€Ğ¾ĞµĞ½ Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¾ĞºÑĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ dashboard/statics/api
- âœ… ĞĞ´Ğ¼Ğ¸Ğ½ ÑĞ¾Ğ·Ğ´Ğ°Ğ½ Ğ² Ğ‘Ğ”
- âœ… Ğ’ÑĞµ ÑĞµÑ€Ğ²Ğ¸ÑÑ‹ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ÑÑ‚

### 19-20 Ñ„ĞµĞ²Ñ€Ğ°Ğ»Ñ 2026
- âœ… Ğ¡ĞµÑ€Ğ²ĞµÑ€ Ñ€Ğ°Ğ·Ğ²Ñ‘Ñ€Ğ½ÑƒÑ‚
- âœ… SSL Ğ½Ğ°ÑÑ‚Ñ€Ğ¾ĞµĞ½ (Let's Encrypt)
- âœ… VPN Bot + Mini App Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ÑÑ‚
- âœ… YooKassa Ğ¸Ğ½Ñ‚ĞµĞ³Ñ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ°
- âœ… WireGuard Ğ½Ğ°ÑÑ‚Ñ€Ğ¾ĞµĞ½

---

*Ğ”Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»Ñ‘Ğ½: 21 Ñ„ĞµĞ²Ñ€Ğ°Ğ»Ñ 2026 Ğ³.*
